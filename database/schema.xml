<?xml version="1.0" encoding="UTF-8"?>
<database name="gw2exchange" defaultIdMethod="native" namespace="GW2Exchange\Database">
  <!--
    A table of items, using a minimal representation because most attributes are not going to be used
    (7/02/2015) at the moment dont care about item history because we aren't using the info in any way other than simple displaying
  -->
  <table name="item">
    <column name="id" type="integer" required="true" primaryKey="true" />
    <column name="name" type="varchar" size="255" required="true" />
    <column name="icon" type="varchar" size="255" required="true" />
    <column name="hash" type="varchar" size="3000" required="true" />
    <column name="cache_time" type="integer" required="true" />
    <behavior name="timestampable" />
    <behavior name="query_cache" />
  </table>

  <!--
    The table with more of the item's information
  -->
  <table name="item_info">
    <!-- setting primary key to true, makes propel treat it as a 1-1 relation -->
    <column name="item_id" type="integer" required="required" primaryKey="true" />
    <column name="description" type="LONGVARCHAR" />
    <column name="type" type="varchar" size="255" required="true" />
    <column name="rarity" type="varchar" size="255" required="true" />
    <column name="level" type="integer" required="true" />
    <column name="vendor_value" type="integer" required="true" />
    <column name="default_skin" type="integer" />
    <column name="flags" type="varchar" size="255" required="true" />
    <column name="game_types" type="varchar" size="255" required="true" />
    <column name="restrictions" type="varchar" size="255" required="true" />
    <foreign-key foreignTable="item">
      <reference local="item_id" foreign="id"/>
    </foreign-key>
    <behavior name="query_cache" />
  </table>

  <!--
    A table which is the value of item for the item detail
  -->
  <table name="item_item_detail" isCrossRef="true">
    <column name="item_id" type="integer" required="required" primaryKey="true"/>
    <column name="item_detail_id" type="integer" required="required" primaryKey="true"/>
    <column name="value" type="LONGVARCHAR"/>
    <foreign-key foreignTable="item">
      <reference local="item_id" foreign="id"/>
    </foreign-key>
    <foreign-key foreignTable="item_detail">
      <reference local="item_detail_id" foreign="id"/>
    </foreign-key>
    <behavior name="query_cache" />
  </table>

  <!--
    The Item's detail, it varies based on the item's type
    this table will most likely not change very often, because it is all of the attributes that
    GW decides to add into the game
    It is only the label, the actual values for the detail will be in the itemitemdetails table
  -->
  <table name="item_detail">
    <column name="id" type="integer" primaryKey="true"  autoIncrement="true" />
    <column name="item_type" type="varchar" size="255" required="true" />
    <!-- what the item detail is called -->
    <column name="label" type="varchar" size="255" required="true" />
    <!-- the variable type ex number, string, array not sure if this will be used -->
    <column name="value_type" type="varchar" size="255" />
    <unique>
      <unique-column name="item_type" />
      <unique-column name="label" />
    </unique>
    <behavior name="query_cache" />
  </table>

  <table name="listing">
    <column name="id" type="integer" primaryKey="true" autoIncrement="true" />
    <column name="item_id" type="integer" required="true" />
    <foreign-key foreignTable="item">
      <reference local="item_id" foreign="id"/>
    </foreign-key>
    <!-- Type is either buy or sell for the type of order -->
    <column name="type" type="varchar" required="true"/>
    <!-- The number of individual listings this object refers to (e.g. two players selling at the same price will end up in the same listing) -->
    <column name="orders" type="integer" required="true"/>
    <column name="unit_price" type="integer" required="true"/>
    <column name="quantity" type="integer" required="true"/>
    <column name="cache_time" type="integer" required="true" />
    <unique>
      <unique-column name="item_id" />
      <unique-column name="type" />
      <unique-column name="unit_price" />
    </unique>
    <behavior name="timestampable" />
    <behavior name="query_cache" />
  </table>
    <!--
      This table has the information that would be visible from the trading place's screen.
      So it shows the highest buy and lowest sell along with qtys.
      It's to be used as a quick survey over every item when scanning, rather than load each ones' details
     -->
  <table name="price">
    <!-- setting primary key to true, makes propel treat it as a 1-1 relation -->
    <column name="item_id" type="integer" primaryKey="true" required="true" />
    <column name="buy_price" type="integer" required="true" />
    <column name="sell_price" type="integer" required="true" />
    <column name="buy_qty" type="integer" required="true" />
    <column name="sell_qty" type="integer" required="true" />
    <column name="hash" type="varchar" size="128" required="true" />
    <column name="profit" type="integer" />
    <column name="roi" type="float" />
    <column name="cache_time" type="integer" defaultValue="4" />
    <column name="max_buy" type="integer" />
    <column name="min_buy" type="integer" />
    <column name="max_sell" type="integer" />
    <column name="min_sell" type="integer" />
    <index>
      <index-column name="max_buy" />
    </index>
    <index>
      <index-column name="min_buy" />
    </index>
    <index>
      <index-column name="max_sell" />
    </index>
    <index>
      <index-column name="min_sell" />
    </index>
    <foreign-key foreignTable="item">
      <reference local="item_id" foreign="id"/>
    </foreign-key>
    <behavior name="timestampable" />
    <behavior name="query_cache" />
  </table>

  <!-- price history records get added when the price changes, so the most recent price history is the current price-->
  <table name="price_history">
    <column name="id" type="integer" primaryKey="true" autoIncrement="true" />
    <column name="item_id" type="integer" required="true" />
    <column name="buy_price" type="integer" required="true" />
    <column name="sell_price" type="integer" required="true" />
    <column name="buy_qty" type="integer" required="true" />
    <column name="sell_qty" type="integer" required="true" />
    <column name="hash" type="varchar" size="128" required="true" />
    <column name="profit" type="integer" />
    <column name="roi" type="float" />
    <unique>
      <unique-column name="item_id" />
      <unique-column name="created_at" />
    </unique>
    <foreign-key foreignTable="item">
      <reference local="item_id" foreign="id"/>
    </foreign-key>
    <foreign-key foreignTable="price">
      <reference local="item_id" foreign="item_id"/>
    </foreign-key>
    <behavior name="timestampable">
      <parameter name="disable_updated_at" value="true" />
    </behavior>
    <behavior name="query_cache" />
  </table>

  <!-- keep a log of all requests and whether the cached results were used -->
  <table name="price_request_log_entry">
    <column name="id" type="integer" primaryKey="true" autoIncrement="true" />
    <column name="price_history_id" type="integer" required="true" />
    <column name="cache_hit" type="integer" required="true" />
    <column name="cache_correct" type="integer" />
    <foreign-key foreignTable="price_history">
      <reference local="price_history_id" foreign="id"/>
    </foreign-key>
    <behavior name="timestampable">
      <parameter name="disable_updated_at" value="true" />
    </behavior>
  </table>

  <!-- keep a log of all price update checks -->
  <table name="price_update_check_log_entry">
    <column name="id" type="integer" primaryKey="true" autoIncrement="true" />
    <column name="price_history_id" type="integer" required="true" />
    <column name="isModified" type="integer" required="true" />
    <foreign-key foreignTable="price_history">
      <reference local="price_history_id" foreign="id"/>
    </foreign-key>
    <behavior name="timestampable">
      <parameter name="disable_updated_at" value="true" />
    </behavior>
  </table>
</database>